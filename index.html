<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tube Link Pro - Dashboard Edition</title>
    <link rel="icon" href="https://i.ibb.co/rRNhv33x/screenshot.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        body {
            background-color: #09090b;
            color: #fafafa;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .purple-gradient {
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
        }

        .glass-card {
            background: rgba(24, 24, 27, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(168, 85, 247, 0.1);
        }

        .video-16-9 {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            border-radius: 24px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .video-16-9 iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Toast Animation */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-item {
            animation: slideIn 0.3s ease-out forwards;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #09090b;
        }

        ::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a855f7;
        }

        .api-btn-active {
            background: #a855f7 !important;
            color: white !important;
            border-color: #a855f7 !important;
        }
    </style>
</head>

<body>

    <div id="toastContainer" class="fixed bottom-5 right-5 z-[1000] flex flex-col gap-3"></div>

    <div id="profileModal"
        class="fixed inset-0 z-[200] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
        <div class="glass-card w-full max-w-md p-8 rounded-[32px] shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-extrabold uppercase tracking-tighter">Cài đặt <span class="text-purple-500">Hồ
                        Sơ</span></h3>
                <button onclick="toggleProfileModal()" class="text-zinc-500 hover:text-white"><i
                        class="fas fa-times"></i></button>
            </div>

            <div class="space-y-6">
                <div class="flex flex-col items-center gap-4">
                    <img id="modalAvatarPreview" src=""
                        class="w-24 h-24 rounded-full border-4 border-purple-500 object-cover shadow-lg shadow-purple-500/20">
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('avatarFileInput').click()"
                            class="text-[10px] bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-full font-bold transition-all">CHỌN
                            FILE</button>
                        <input type="file" id="avatarFileInput" accept="image/*" class="hidden"
                            onchange="handleFileSelect(this)">
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-zinc-500 ml-2 uppercase">Tên hiển thị</label>
                        <input id="editUserName" type="text"
                            class="w-full bg-zinc-950 border border-zinc-800 p-4 rounded-2xl outline-none focus:border-purple-500 transition-all text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-zinc-500 ml-2 uppercase">Link ảnh đại diện</label>
                        <input id="editAvatarUrl" type="text" placeholder="https://..."
                            class="w-full bg-zinc-950 border border-zinc-800 p-4 rounded-2xl outline-none focus:border-purple-500 transition-all text-sm">
                    </div>
                </div>

                <button onclick="saveProfile()"
                    class="w-full purple-gradient p-4 rounded-2xl font-bold shadow-lg shadow-purple-500/30 hover:scale-[1.02] active:scale-95 transition-all">LƯU
                    THAY ĐỔI</button>
            </div>
        </div>
    </div>

    <div id="authModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-[#09090b]">
        <div class="bg-zinc-900/50 border border-zinc-800 p-10 rounded-[40px] w-full max-w-md shadow-2xl text-center">
            <img src="https://i.ibb.co/rRNhv33x/screenshot.png" class="w-20 h-20 mx-auto mb-6 rounded-3xl shadow-2xl">
            <h2 id="authTitle" class="text-3xl font-black mb-8 tracking-tighter uppercase">Tube <span
                    class="text-purple-500">Link</span></h2>
            <div class="space-y-4">
                <input id="authUser" type="text" placeholder="Tên đăng nhập"
                    class="w-full bg-black border border-zinc-800 p-4 rounded-2xl outline-none focus:border-purple-600 transition-all text-sm">
                <input id="authPass" type="password" placeholder="Mật khẩu"
                    class="w-full bg-black border border-zinc-800 p-4 rounded-2xl outline-none focus:border-purple-600 transition-all text-sm">
                <button onclick="handleAuth()"
                    class="w-full purple-gradient p-4 rounded-2xl font-bold shadow-lg shadow-purple-500/20 hover:opacity-90 transition-all">TIẾP
                    TỤC</button>
                <p class="text-zinc-500 text-xs mt-4 cursor-pointer hover:text-purple-400 transition-all"
                    onclick="toggleAuthMode()" id="authToggle">Chưa có tài khoản? Đăng ký ngay</p>
            </div>
        </div>
    </div>

    <nav
        class="fixed top-0 w-full bg-[#09090b]/80 backdrop-blur-xl border-b border-zinc-800/50 flex items-center justify-between px-8 py-4 z-50">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="location.reload()">
            <div class="p-2 bg-purple-500/10 rounded-xl group-hover:bg-purple-500/20 transition-all">
                <img src="https://i.ibb.co/rRNhv33x/screenshot.png" class="w-8 h-8 rounded-lg">
            </div>
            <span class="text-xl font-black uppercase tracking-tighter hidden md:block">Tube <span
                    class="text-purple-500">Link</span></span>
        </div>

        <div class="flex-1 max-w-xl mx-8">
            <div
                class="flex bg-zinc-900/50 border border-zinc-800 rounded-full px-5 py-2 focus-within:border-purple-500/50 transition-all">
                <input id="searchInput" type="text" placeholder="Khám phá video bạn yêu thích..."
                    class="w-full bg-transparent outline-none text-sm py-1">
                <button onclick="handleSearch()" class="text-zinc-500 hover:text-purple-500"><i
                        class="fas fa-search"></i></button>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-all"
                onclick="toggleProfileModal()">
                <div class="text-right hidden sm:block">
                    <p id="userNameDisplay" class="text-[11px] font-black uppercase tracking-wider leading-none"></p>
                    <span class="text-[9px] text-purple-500 font-bold">PRO MEMBER</span>
                </div>
                <img id="userAvatarImg" src=""
                    class="w-10 h-10 rounded-full object-cover border-2 border-purple-500/30 p-0.5">
            </div>
            <button onclick="logout()" class="text-zinc-600 hover:text-red-500 transition-all"><i
                    class="fas fa-power-off"></i></button>
        </div>
    </nav>

    <main class="pt-28 px-8 max-w-[1600px] mx-auto pb-20">
        <div class="flex flex-col lg:flex-row gap-10">
            <div class="flex-1">
                <div id="playerSection" class="hidden mb-12">
                    <div class="video-16-9">
                        <iframe id="mainIframe" src="" frameborder="0" allowfullscreen allow="autoplay"></iframe>
                    </div>
                    <div class="mt-8 flex justify-between items-start">
                        <div>
                            <h1 id="vTitle" class="text-2xl font-black text-white leading-tight mb-2"></h1>
                            <div class="flex gap-2">
                                <span
                                    class="px-3 py-1 bg-zinc-900 rounded-full text-[10px] font-bold text-zinc-400 border border-zinc-800">4K
                                    ULTRA HD</span>
                                <span
                                    class="px-3 py-1 bg-purple-500/10 rounded-full text-[10px] font-bold text-purple-400 border border-purple-500/20">PREMIUM
                                    SERVER</span>
                            </div>
                        </div>
                        <button onclick="switchServer()"
                            class="bg-zinc-900 border border-zinc-800 text-[10px] px-6 py-3 rounded-2xl hover:bg-zinc-800 font-black uppercase tracking-widest transition-all">Chuyển
                            Server Dự Phòng</button>
                    </div>
                </div>

                <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8"></div>

                <div id="pagination" class="hidden mt-16 flex justify-center items-center gap-10">
                    <button id="prevBtn" onclick="changePage('prev')"
                        class="p-4 rounded-2xl bg-zinc-900 border border-zinc-800 hover:border-purple-500 disabled:opacity-20 transition-all"><i
                            class="fas fa-chevron-left mr-2"></i> TRƯỚC</button>
                    <button id="nextBtn" onclick="changePage('next')"
                        class="p-4 rounded-2xl bg-zinc-900 border border-zinc-800 hover:border-purple-500 disabled:opacity-20 transition-all">TIẾP
                        THEO <i class="fas fa-chevron-right ml-2"></i></button>
                </div>
            </div>

            <div class="w-full lg:w-[380px] space-y-8">
                <div class="glass-card p-6 rounded-[32px] space-y-6">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-black tracking-widest text-zinc-500 uppercase">Hệ thống API</span>
                        <div id="apiStatusIndicator"
                            class="flex items-center gap-2 text-[10px] text-green-500 font-bold">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> ONLINE
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between text-[10px] font-bold text-zinc-500 uppercase px-1">
                            <span>Chọn Server (1-10)</span>
                            <span id="currentKeyLabel" class="text-purple-500">SERVER #1</span>
                        </div>
                        <div id="serverGrid" class="grid grid-cols-5 gap-2">
                        </div>
                    </div>

                    <div class="pt-4 border-t border-zinc-800/50 space-y-4">
                        <div
                            class="flex items-center justify-between bg-zinc-950 p-3 rounded-2xl border border-zinc-800">
                            <span class="text-[11px] font-bold text-zinc-400">Chế độ API Cá Nhân</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="apiToggle" class="sr-only peer" onchange="toggleApiMode()">
                                <div
                                    class="w-10 h-5 bg-zinc-800 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600 peer-checked:after:bg-white">
                                </div>
                            </label>
                        </div>

                        <div id="personalInputZone" class="hidden space-y-3">
                            <input id="newPersonalKey" type="text" placeholder="Dán API Key của bạn..."
                                class="w-full bg-black border border-zinc-800 p-3 rounded-xl text-[10px] outline-none focus:border-purple-500 transition-all">
                            <button onclick="addPersonalKey()"
                                class="w-full py-3 bg-purple-600/10 text-purple-500 rounded-xl text-[10px] font-bold border border-purple-500/20 hover:bg-purple-600/20 transition-all">+
                                LƯU VÀO DANH SÁCH</button>
                            <div id="personalKeysContainer" class="max-h-32 overflow-y-auto space-y-2 pr-2"></div>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-6 rounded-[32px]">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-xs font-black tracking-widest text-zinc-500 uppercase">Lịch sử xem</span>
                        <button onclick="clearWatchHistory()"
                            class="text-[10px] text-zinc-600 hover:text-red-500 font-bold transition-all">XÓA TẤT
                            CẢ</button>
                    </div>
                    <div id="historyList" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const SYSTEM_KEYS = [
            'AIzaSyAlPGJ5uNvGOqej7peEsMbLM-o0KTBIKpA', 'AIzaSyDOdje8NKBfjxFXr0tx0XsogJCJ49aQHIY',
            'AIzaSyAaSUZ4qz9XyyQtqFROMfIjJX1XJBTxk_0', 'AIzaSyBpcZownZn5LpKZmqG81Fjxq19LNM6w4Lc',
            'AIzaSyDDIyJl5Y3A-5VeItqc7Cm5pz1TVOeb60w', 'AIzaSyDXUC00CO5eblahnmEZTxJDyKJgD_KGEMw',
            'AIzaSyCi9g8JfoczO0406S9Wptu8dY8vRoOcwh4', 'AIzaSyD03V_D_18WEx_G7L_Yp5J4E0X9812M1A',
            'AIzaSyB8K_X_J9K_W_P10_Example_Actual_9', 'AIzaSyC10_L_M_O_P_Example_Actual_10'
        ];

        let currentKeyIndex = 0;
        let currentUser = null;
        let authMode = 'login';
        let currentQuery = 'Minecraft Music';
        let nextPageToken = '';
        let prevPageTokens = [];
        let currentVideoId = '';
        let personalKeys = [];
        let usePersonal = false;

        // --- TOAST SYSTEM ---
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle');
            const color = type === 'success' ? 'text-green-500' : (type === 'error' ? 'text-red-500' : 'text-purple-500');

            toast.className = `toast-item glass-card px-6 py-4 rounded-2xl flex items-center gap-4 min-w-[280px] shadow-2xl border-l-4 ${type === 'success' ? 'border-l-green-500' : (type === 'error' ? 'border-l-red-500' : 'border-l-purple-500')}`;
            toast.innerHTML = `
                <i class="fas ${icon} ${color} text-lg"></i>
                <div class="flex-1">
                    <p class="text-xs font-bold text-white">${msg}</p>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- PROFILE MODAL LOGIC ---
        function toggleProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal.classList.contains('hidden')) {
                const users = JSON.parse(localStorage.getItem('tl_users'));
                const user = users[currentUser];
                document.getElementById('editUserName').value = currentUser;
                document.getElementById('editAvatarUrl').value = user.avatar || '';
                document.getElementById('modalAvatarPreview').src = user.avatar || `https://ui-avatars.com/api/?name=${currentUser}`;
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('modalAvatarPreview').src = e.target.result;
                    document.getElementById('editAvatarUrl').value = "File đã chọn (Base64)";
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProfile() {
            const newName = document.getElementById('editUserName').value.trim();
            const newAvatar = document.getElementById('modalAvatarPreview').src;

            if (!newName) return showToast("Tên không được để trống", "error");

            let users = JSON.parse(localStorage.getItem('tl_users'));

            // Rename logic
            if (newName !== currentUser) {
                if (users[newName]) return showToast("Tên này đã tồn tại!", "error");
                users[newName] = users[currentUser];
                delete users[currentUser];
                localStorage.setItem('tl_current', newName);
                currentUser = newName;
            }

            users[currentUser].avatar = newAvatar;
            localStorage.setItem('tl_users', JSON.stringify(users));

            initApp();
            toggleProfileModal();
            showToast("Cập nhật hồ sơ thành công!", "success");
        }

        // --- API SERVER SELECTION ---
        function renderServerGrid() {
            const grid = document.getElementById('serverGrid');
            grid.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const btn = document.createElement('button');
                btn.className = `p-2 text-[10px] font-bold border border-zinc-800 rounded-lg bg-zinc-950 hover:border-purple-500 transition-all ${!usePersonal && currentKeyIndex === i ? 'api-btn-active' : ''}`;
                btn.innerText = i + 1;
                btn.onclick = () => selectServer(i);
                grid.appendChild(btn);
            }
        }

        function selectServer(index) {
            if (usePersonal) {
                showToast("Vui lòng tắt 'API Cá Nhân' để chọn Server hệ thống", "info");
                return;
            }
            currentKeyIndex = index;
            document.getElementById('currentKeyLabel').innerText = `SERVER #${index + 1}`;
            renderServerGrid();
            handleSearch(currentQuery);
            showToast(`Đã chuyển sang Server #${index + 1}`, "success");
        }

        // --- CORE API & APP LOGIC ---
        async function fetchYT(url) {
            const keys = (usePersonal && personalKeys.length > 0) ? personalKeys : SYSTEM_KEYS;
            const currentKey = keys[currentKeyIndex] || keys[0];

            try {
                const response = await fetch(`${url}&key=${currentKey}`);
                const data = await response.json();
                if (data.error) {
                    const isQuota = data.error.code === 403;
                    showToast(isQuota ? "Server này hết hạn mức, vui lòng đổi server!" : data.error.message, "error");
                    return { items: [] };
                }
                return data;
            } catch (err) {
                showToast("Lỗi kết nối mạng!", "error");
                return { items: [] };
            }
        }

        async function handleSearch(query = null, token = '') {
            const q = query || document.getElementById('searchInput').value.trim();
            if (!q) return;
            currentQuery = q;
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '<div class="col-span-full text-center py-20 opacity-50"><i class="fas fa-spinner fa-spin text-3xl text-purple-500 mb-4"></i><p class="text-xs font-bold tracking-widest uppercase">Đang tìm kiếm...</p></div>';

            const data = await fetchYT(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=12&q=${encodeURIComponent(q)}&type=video&pageToken=${token}`);

            if (data && data.items && data.items.length > 0) {
                nextPageToken = data.nextPageToken || '';
                renderVideos(data.items);
                document.getElementById('pagination').classList.remove('hidden');
                document.getElementById('prevBtn').disabled = prevPageTokens.length === 0;
                document.getElementById('nextBtn').disabled = !nextPageToken;
            } else {
                grid.innerHTML = '<div class="col-span-full text-center py-20 text-red-500 font-bold uppercase text-xs">Không có kết quả hoặc Server lỗi</div>';
            }
        }

        function renderVideos(items) {
            document.getElementById('videoGrid').innerHTML = items.map(item => `
                <div class="video-card cursor-pointer group" onclick="playVideo('${item.id.videoId}', '${item.snippet.title.replace(/'/g, "\\'")}')">
                    <div class="relative aspect-video rounded-[24px] overflow-hidden mb-4 border border-zinc-800 group-hover:border-purple-500/50 transition-all shadow-lg">
                        <img src="${item.snippet.thumbnails.high.url}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-all">
                            <i class="fas fa-play text-white text-3xl"></i>
                        </div>
                    </div>
                    <h3 class="text-sm font-bold line-clamp-2 text-zinc-300 group-hover:text-purple-400 transition-all">${item.snippet.title}</h3>
                    <p class="text-[10px] text-zinc-600 mt-1 font-bold uppercase tracking-tighter">${item.snippet.channelTitle}</p>
                </div>`).join('');
        }

        function playVideo(id, title) {
            currentVideoId = id;
            document.getElementById('playerSection').classList.remove('hidden');
            document.getElementById('vTitle').innerText = title;
            document.getElementById('mainIframe').src = `https://www.youtube.com/embed/${id}?autoplay=1`;
            saveWatchHistory(id, title);
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast("Đang phát: " + title.substring(0, 30) + "...", "info");
        }

        function toggleApiMode() {
            usePersonal = document.getElementById('apiToggle').checked;
            document.getElementById('personalInputZone').classList.toggle('hidden', !usePersonal);
            currentKeyIndex = 0;
            renderServerGrid();
            document.getElementById('currentKeyLabel').innerText = usePersonal ? "PERSONAL API" : "SERVER #1";
            handleSearch(currentQuery);
            showToast(usePersonal ? "Đã bật API cá nhân" : "Đã quay lại Server hệ thống", "info");
        }

        function addPersonalKey() {
            const input = document.getElementById('newPersonalKey');
            const key = input.value.trim();
            if (key) {
                personalKeys.push(key);
                input.value = '';
                saveToLocal();
                renderPersonalKeys();
                showToast("Đã thêm API mới!", "success");
            }
        }

        function renderPersonalKeys() {
            const container = document.getElementById('personalKeysContainer');
            container.innerHTML = personalKeys.map((k, i) => `
                <div class="flex items-center justify-between bg-black/40 p-3 rounded-xl border border-zinc-800 text-[9px] hover:border-purple-500/30 transition-all">
                    <span class="truncate w-48 text-zinc-500 font-mono">${k}</span>
                    <button onclick="removePersonalKey(${i})" class="text-zinc-600 hover:text-red-500"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function removePersonalKey(i) {
            personalKeys.splice(i, 1);
            saveToLocal();
            renderPersonalKeys();
            showToast("Đã xóa API", "info");
        }

        function saveToLocal() {
            let users = JSON.parse(localStorage.getItem('tl_users'));
            users[currentUser].personalKeys = personalKeys;
            localStorage.setItem('tl_users', JSON.stringify(users));
        }

        function saveWatchHistory(id, title) {
            let users = JSON.parse(localStorage.getItem('tl_users'));
            let history = users[currentUser].watchHistory || [];
            history = history.filter(v => v.id !== id);
            history.unshift({ id, title });
            if (history.length > 8) history.pop();
            users[currentUser].watchHistory = history;
            localStorage.setItem('tl_users', JSON.stringify(users));
            renderHistory();
        }

        function renderHistory() {
            let users = JSON.parse(localStorage.getItem('tl_users'));
            let history = users[currentUser].watchHistory || [];
            const list = document.getElementById('historyList');
            if (history.length === 0) {
                list.innerHTML = '<div class="text-center text-zinc-700 text-[10px] font-bold py-4">CHƯA CÓ DỮ LIỆU</div>';
                return;
            }
            list.innerHTML = history.map(v => `
                <div class="group flex items-center gap-3 p-2 hover:bg-zinc-900 rounded-xl transition-all cursor-pointer" onclick="playVideo('${v.id}', '${v.title.replace(/'/g, "\\'")}')">
                    <div class="w-2 h-2 rounded-full bg-zinc-800 group-hover:bg-purple-500 transition-all"></div>
                    <div class="text-[11px] text-zinc-500 truncate group-hover:text-zinc-200 font-bold">${v.title}</div>
                </div>
            `).join('');
        }

        function handleAuth() {
            const u = document.getElementById('authUser').value.trim();
            const p = document.getElementById('authPass').value.trim();
            if (!u || !p) return showToast("Vui lòng điền đủ thông tin", "error");

            let users = JSON.parse(localStorage.getItem('tl_users')) || {};
            if (authMode === 'register') {
                if (users[u]) return showToast("Tên này đã tồn tại", "error");
                users[u] = { pass: p, watchHistory: [], personalKeys: [], avatar: `https://ui-avatars.com/api/?name=${u}&background=a855f7&color=fff` };
                localStorage.setItem('tl_users', JSON.stringify(users));
                showToast("Đăng ký thành công!", "success");
                toggleAuthMode();
            } else {
                if (users[u] && users[u].pass === p) {
                    currentUser = u;
                    localStorage.setItem('tl_current', u);
                    initApp();
                    showToast(`Chào mừng quay trở lại, ${u}!`, "success");
                } else showToast("Sai tên đăng nhập hoặc mật khẩu", "error");
            }
        }

        function initApp() {
            const users = JSON.parse(localStorage.getItem('tl_users'));
            const user = users[currentUser];
            personalKeys = user.personalKeys || [];
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('userNameDisplay').innerText = currentUser;
            document.getElementById('userAvatarImg').src = user.avatar || `https://ui-avatars.com/api/?name=${currentUser}`;

            renderServerGrid();
            renderPersonalKeys();
            renderHistory();
            handleSearch('Minecraft Music');
        }

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('authTitle').innerHTML = authMode === 'login' ? 'Tube <span class="text-purple-500">Link</span>' : 'Đăng <span class="text-purple-500">Ký</span>';
            document.getElementById('authToggle').innerText = authMode === 'login' ? 'Chưa có tài khoản? Đăng ký ngay' : 'Đã có tài khoản? Đăng nhập';
        }

        function logout() { localStorage.removeItem('tl_current'); location.reload(); }

        window.onload = () => {
            const saved = localStorage.getItem('tl_current');
            if (saved) { currentUser = saved; initApp(); }
        };
    </script>
</body>

</html>
