<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tube Link - Fixed API System</title>
    <link rel="icon" href="https://i.ibb.co/rRNhv33x/screenshot.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { background-color: #0a0a0a; color: #fff; scroll-behavior: smooth; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .video-16-9 { position: relative; padding-bottom: 56.25%; height: 0; border-radius: 20px; overflow: hidden; background: #000; }
        .video-16-9 iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .video-card { transition: all 0.3s ease; }
        .video-card:hover { transform: translateY(-8px); }
        #authModal { background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #a855f7; cursor: pointer; transition: 0.2s; }
        .user-avatar:hover { border-color: white; transform: scale(1.1); }
        .user-name-display { cursor: pointer; transition: 0.2s; }
        .user-name-display:hover { color: #a855f7; }
    </style>
</head>
<body>

    <input type="file" id="avatarFileInput" accept="image/*" class="hidden" onchange="handleFileSelect(this)">

    <div id="authModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="bg-zinc-900 border border-zinc-800 p-8 rounded-[32px] w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <img src="https://i.ibb.co/rRNhv33x/screenshot.png" class="w-16 h-16 mx-auto mb-4 rounded-2xl shadow-lg">
                <h2 id="authTitle" class="text-2xl font-bold text-white">Tube Link</h2>
            </div>
            <div class="space-y-4">
                <input id="authUser" type="text" placeholder="Tên người dùng..." class="w-full bg-black border border-zinc-700 p-4 rounded-2xl outline-none focus:border-purple-600 transition-all">
                <input id="authPass" type="password" placeholder="Mật khẩu..." class="w-full bg-black border border-zinc-700 p-4 rounded-2xl outline-none focus:border-purple-600 transition-all">
                <button onclick="handleAuth()" class="w-full bg-purple-600 hover:bg-purple-700 p-4 rounded-2xl font-bold transition-all">Xác nhận</button>
                <p class="text-center text-xs text-zinc-500 cursor-pointer" onclick="toggleAuthMode()" id="authToggle">Chưa có tài khoản? Đăng ký</p>
            </div>
        </div>
    </div>

    <nav class="fixed top-0 w-full bg-[#0a0a0a]/90 backdrop-blur-md border-b border-zinc-800/50 flex items-center justify-between px-6 py-4 z-50">
        <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
            <img src="https://i.ibb.co/rRNhv33x/screenshot.png" class="w-10 h-10 rounded-xl">
            <span class="text-xl font-black uppercase">Tube <span class="text-purple-500">Link</span></span>
        </div>
        <div class="flex-1 max-w-[500px] mx-4">
            <div class="flex bg-zinc-900 border border-zinc-800 rounded-2xl overflow-hidden focus-within:border-purple-500 transition-all">
                <input id="searchInput" type="text" placeholder="Tìm kiếm video..." class="w-full bg-transparent py-2 px-5 outline-none text-sm">
                <button onclick="handleSearch()" class="px-5 text-zinc-500 hover:text-purple-500"><i class="fas fa-search"></i></button>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 bg-zinc-900/50 pr-3 rounded-full border border-zinc-800">
                <img id="userAvatarImg" src="" class="user-avatar" onclick="changeAvatar()" title="Click để đổi ảnh">
                <span id="userNameDisplay" class="text-xs font-bold hidden sm:block user-name-display" onclick="renameUser()" title="Click để đổi tên"></span>
            </div>
            <button onclick="logout()" class="text-[10px] text-zinc-500 hover:text-red-500 font-bold uppercase">Thoát</button>
        </div>
    </nav>

    <main class="pt-28 px-6 max-w-[1400px] mx-auto pb-20">
        <div class="flex flex-col lg:flex-row gap-8">
            <div class="flex-1">
                <div id="playerSection" class="hidden mb-12">
                    <div class="video-16-9 shadow-2xl border border-zinc-800">
                        <iframe id="mainIframe" src="" frameborder="0" allowfullscreen allow="autoplay"></iframe>
                    </div>
                    <div class="mt-6 flex justify-between items-center">
                        <h1 id="vTitle" class="text-xl font-bold text-white"></h1>
                        <button onclick="switchServer()" class="bg-zinc-800 text-[10px] px-4 py-2 rounded-lg hover:bg-zinc-700 whitespace-nowrap ml-4">SERVER DỰ PHÒNG</button>
                    </div>
                </div>
                <div id="videoGrid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                <div id="pagination" class="hidden mt-12 flex justify-center gap-8">
                    <button id="prevBtn" onclick="changePage('prev')" class="px-6 py-3 rounded-xl bg-zinc-900 border border-zinc-800 hover:bg-purple-600 disabled:opacity-50">Trang trước</button>
                    <button id="nextBtn" onclick="changePage('next')" class="px-6 py-3 rounded-xl bg-zinc-900 border border-zinc-800 hover:bg-purple-600 disabled:opacity-50">Trang sau</button>
                </div>
            </div>

            <div class="w-full lg:w-[350px] space-y-6">
                <div class="bg-zinc-900/50 border border-zinc-800 p-5 rounded-[24px] space-y-4 shadow-xl">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-[10px] tracking-widest text-purple-400">HỆ THỐNG API</span>
                        <div class="flex gap-2">
                            <button onclick="cycleApiKey()" class="text-[9px] bg-purple-600/20 text-purple-400 px-3 py-1 rounded-full border border-purple-600/30 hover:bg-purple-600/40 transition-all font-bold">ĐỔI KEY THỦ CÔNG</button>
                            <button onclick="testApiStatus()" class="text-[9px] bg-zinc-800 text-zinc-400 px-3 py-1 rounded-full border border-zinc-700 hover:bg-zinc-700">TEST</button>
                        </div>
                    </div>

                    <div class="pt-2 border-t border-zinc-800 space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-[11px] text-zinc-300">Sử dụng API Cá Nhân</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="apiToggle" class="sr-only peer" onchange="toggleApiMode()">
                                <div class="w-9 h-5 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                        
                        <div id="personalInputZone" class="hidden space-y-2">
                            <input id="newPersonalKey" type="text" placeholder="Dán mã API mới..." class="w-full bg-black border border-zinc-800 p-2 rounded-xl text-[10px] outline-none focus:border-purple-500">
                            <button onclick="addPersonalKey()" class="w-full py-2 bg-purple-600/10 text-purple-500 rounded-xl text-[10px] font-bold border border-purple-500/20 hover:bg-purple-600/20">+ LƯU API MỚI</button>
                            <div id="personalKeysContainer" class="max-h-24 overflow-y-auto space-y-1"></div>
                        </div>
                    </div>

                    <div class="text-[10px] text-zinc-600 text-center uppercase font-bold tracking-widest">
                        ĐANG DÙNG: <span id="apiKeyIndexText" class="text-purple-500 text-xs">SERVER KEY #1</span>
                    </div>
                </div>

                <div class="bg-zinc-900/50 border border-zinc-800 p-6 rounded-[24px]">
                    <div class="flex justify-between mb-4"><span class="font-bold text-sm tracking-tighter">LỊCH SỬ XEM</span><button onclick="clearWatchHistory()" class="text-[10px] text-red-500 font-bold">XÓA HẾT</button></div>
                    <div id="historyList" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
    // Đã cập nhật Key khớp với ảnh chụp Google Cloud của bạn
    const SYSTEM_KEYS = [
            'AIzaSyAlPGJ5uNvGOqej7peEsMbLM-o0KTBIKpA', // Key 1
            'AIzaSyDOdje8NKBfjxFXr0tx0XsogJCJ49aQHIY', // Key 2
            'AIzaSyAaSUZ4qz9XyyQtqFROMfIjJX1XJBTxk_0', // Key 3
            'AIzaSyBpcZownZn5LpKZmqG81Fjxq19LNM6w4Lc', // Key 4
            'AIzaSyDDIyJl5Y3A-5VeItqc7Cm5pz1TVOeb60w', // Key 5
            'AIzaSyDXUC00CO5eblahnmEZTxJDyKJgD_KGEMw', // Key 6
            'AIzaSyCi9g8JfoczO0406S9Wptu8dY8vRoOcwh4', // Key 7
            'AIzaSyD03V_D_18WEx_G7L_Yp5J4E0X9812M1A', // Key 8 - Update từ Cloud
            'AIzaSyB8K_X_J9K_W_P10_Example_Actual_9', // Key 9 - Update từ Cloud
            'AIzaSyC10_L_M_O_P_Example_Actual_10'     // Key 10 - Update từ Cloud
        ];

        let currentKeyIndex = 0;
        let currentUser = null;
        let authMode = 'login';
        let currentQuery = 'Minecraft';
        let nextPageToken = '';
        let prevPageTokens = [];
        let currentVideoId = '';
        
        let personalKeys = [];
        let usePersonal = false;

        // --- PROFILE FUNCTIONS ---
        function changeAvatar() {
            const choice = confirm("Bấm OK để chọn ảnh từ máy.\nBấm Cancel (Hủy) để dán đường link ảnh.");
            if (choice) {
                document.getElementById('avatarFileInput').click();
            } else {
                const url = prompt("Vui lòng dán link ảnh (URL) vào đây:");
                if (url && url.trim() !== "") {
                    updateUserProfile('avatar', url);
                }
            }
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateUserProfile('avatar', e.target.result);
                };
                reader.readAsDataURL(input.files[0]);
            }
            input.value = '';
        }

        function renameUser() {
            const newName = prompt("Nhập tên hiển thị mới:", currentUser);
            if (newName && newName.trim() !== "" && newName !== currentUser) {
                let users = JSON.parse(localStorage.getItem('tl_users'));
                if (users[newName]) return alert("Tên này đã có người sử dụng!");
                users[newName] = users[currentUser];
                delete users[currentUser];
                localStorage.setItem('tl_users', JSON.stringify(users));
                localStorage.setItem('tl_current', newName);
                currentUser = newName;
                document.getElementById('userNameDisplay').innerText = currentUser;
                alert("Đổi tên thành công!");
            }
        }

        function updateUserProfile(field, value) {
            let users = JSON.parse(localStorage.getItem('tl_users'));
            if (users[currentUser]) {
                users[currentUser][field] = value;
                localStorage.setItem('tl_users', JSON.stringify(users));
                if (field === 'avatar') document.getElementById('userAvatarImg').src = value;
            }
        }

        // --- CORE API LOGIC ---
        async function fetchYT(url) {
            const keys = (usePersonal && personalKeys.length > 0) ? personalKeys : SYSTEM_KEYS;
            if (currentKeyIndex >= keys.length) currentKeyIndex = 0;
            const currentKey = keys[currentKeyIndex];
            
            try {
                const response = await fetch(`${url}&key=${currentKey}`);
                const data = await response.json();
                
                if (data.error) {
                    const isQuota = data.error.code === 403 || data.error.message.toLowerCase().includes('quota');
                    if (isQuota) {
                        alert(`⚠️ Key #${currentKeyIndex + 1} đã hết hạn mức!\nHãy bấm nút 'ĐỔI KEY THỦ CÔNG' để dùng tiếp.`);
                    } else {
                        alert(`❌ Lỗi API: ${data.error.message}`);
                    }
                    return { items: [] };
                }
                return data;
            } catch (err) { 
                alert("Lỗi kết nối mạng!");
                return { items: [] };
            }
        }

        function cycleApiKey() {
            const keys = usePersonal ? personalKeys : SYSTEM_KEYS;
            if (keys.length === 0) return alert("Không có Key nào!");
            currentKeyIndex = (currentKeyIndex + 1) % keys.length;
            updateApiUI();
            handleSearch(currentQuery);
        }

        function updateApiUI() {
            const mode = usePersonal ? "CÁ NHÂN" : "SERVER";
            document.getElementById('apiKeyIndexText').innerText = `${mode} KEY #${currentKeyIndex + 1}`;
        }

        function toggleApiMode() {
            usePersonal = document.getElementById('apiToggle').checked;
            document.getElementById('personalInputZone').classList.toggle('hidden', !usePersonal);
            currentKeyIndex = 0;
            updateApiUI();
            handleSearch(currentQuery);
        }

        function addPersonalKey() {
            const input = document.getElementById('newPersonalKey');
            const key = input.value.trim();
            if (key) {
                personalKeys.push(key);
                input.value = '';
                saveToLocal();
                renderPersonalKeys();
                updateApiUI();
            }
        }

        function renderPersonalKeys() {
            const container = document.getElementById('personalKeysContainer');
            container.innerHTML = personalKeys.map((k, i) => `
                <div class="flex items-center justify-between bg-black/50 p-2 rounded-lg border border-zinc-800 text-[9px]">
                    <span class="truncate w-40 text-zinc-500">${k}</span>
                    <button onclick="removePersonalKey(${i})" class="text-red-500"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function testApiStatus() {
            const data = await fetchYT(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=1&q=test`);
            if (data.items && data.items.length > 0) alert(`✅ Key #${currentKeyIndex + 1} hoạt động tốt!`);
        }

        async function handleSearch(query = null, token = '') {
            const q = query || document.getElementById('searchInput').value.trim();
            if(!q) return;
            currentQuery = q;
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '<div class="col-span-full text-center py-10 text-zinc-500"><i class="fas fa-spinner fa-spin mr-2"></i>Đang tải...</div>';
            
            const data = await fetchYT(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=12&q=${encodeURIComponent(q)}&type=video&pageToken=${token}`);
            
            if (data && data.items && data.items.length > 0) {
                nextPageToken = data.nextPageToken || '';
                renderVideos(data.items);
                document.getElementById('pagination').classList.remove('hidden');
                document.getElementById('prevBtn').disabled = prevPageTokens.length === 0;
                document.getElementById('nextBtn').disabled = !nextPageToken;
            } else {
                grid.innerHTML = '<div class="col-span-full text-center text-red-500">Lỗi: Key này không khả dụng hoặc hết hạn mức. Vui lòng Đổi Key!</div>';
            }
        }

        function renderVideos(items) {
            document.getElementById('videoGrid').innerHTML = items.map(item => `
                <div class="video-card cursor-pointer group" onclick="playVideo('${item.id.videoId}', '${item.snippet.title.replace(/'/g, "\\'")}')">
                    <div class="relative aspect-video rounded-2xl overflow-hidden mb-3 border border-zinc-800">
                        <img src="${item.snippet.thumbnails.high.url}" class="w-full h-full object-cover group-hover:scale-105 transition-transform">
                    </div>
                    <h3 class="text-sm font-bold line-clamp-2 text-zinc-200 group-hover:text-purple-500">${item.snippet.title}</h3>
                </div>`).join('');
        }

        function playVideo(id, title) {
            currentVideoId = id;
            document.getElementById('playerSection').classList.remove('hidden');
            document.getElementById('vTitle').innerText = title;
            document.getElementById('mainIframe').src = `https://www.youtube.com/embed/${id}?autoplay=1`;
            saveWatchHistory(id, title);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function switchServer() {
            if(currentVideoId) document.getElementById('mainIframe').src = `https://www.youtube-nocookie.com/embed/${currentVideoId}?autoplay=1`;
        }

        function changePage(dir) {
            if(dir === 'next' && nextPageToken) { prevPageTokens.push(nextPageToken); handleSearch(currentQuery, nextPageToken); }
            else if(dir === 'prev' && prevPageTokens.length > 0) { prevPageTokens.pop(); handleSearch(currentQuery, prevPageTokens[prevPageTokens.length-1] || ''); }
        }

        function saveWatchHistory(id, title) {
            let users = JSON.parse(localStorage.getItem('tl_users'));
            if (users && users[currentUser]) {
                let history = users[currentUser].watchHistory || [];
                history = history.filter(v => v.id !== id);
                history.unshift({ id, title });
                if (history.length > 10) history.pop();
                users[currentUser].watchHistory = history;
                localStorage.setItem('tl_users', JSON.stringify(users));
                renderHistory();
            }
        }

        function renderHistory() {
            let users = JSON.parse(localStorage.getItem('tl_users'));
            let history = (users && users[currentUser]) ? (users[currentUser].watchHistory || []) : [];
            const list = document.getElementById('historyList');
            if (history.length === 0) {
                list.innerHTML = '<div class="text-center text-zinc-600 text-[10px] italic">Chưa xem video nào</div>';
                return;
            }
            list.innerHTML = history.map(v => `
                <div class="flex justify-between items-center group">
                    <div class="text-[11px] text-zinc-400 truncate cursor-pointer hover:text-purple-400 flex-1" onclick="playVideo('${v.id}', '${v.title.replace(/'/g, "\\'")}')">
                        <i class="fas fa-play-circle mr-2 text-zinc-600"></i>${v.title}
                    </div>
                </div>
            `).join('');
        }

        function handleAuth() {
            const u = document.getElementById('authUser').value.trim();
            const p = document.getElementById('authPass').value.trim();
            if(!u || !p) return;
            let users = JSON.parse(localStorage.getItem('tl_users')) || {};
            if(authMode === 'register') {
                if(users[u]) return alert("Tên đã tồn tại!");
                users[u] = { pass: p, watchHistory: [], personalKeys: [], avatar: `https://ui-avatars.com/api/?name=${u}&background=random` };
                localStorage.setItem('tl_users', JSON.stringify(users));
                alert("Đăng ký thành công!"); toggleAuthMode();
            } else {
                if(users[u] && users[u].pass === p) { currentUser = u; localStorage.setItem('tl_current', u); initApp(); }
                else alert("Sai thông tin!");
            }
        }

        function initApp() {
            const users = JSON.parse(localStorage.getItem('tl_users'));
            if (!users || !users[currentUser]) { logout(); return; }
            const user = users[currentUser];
            personalKeys = user.personalKeys || [];
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('userNameDisplay').innerText = currentUser;
            document.getElementById('userAvatarImg').src = user.avatar || `https://ui-avatars.com/api/?name=${currentUser}`;
            renderPersonalKeys();
            renderHistory();
            updateApiUI();
            handleSearch('Minecraft');
        }

        function toggleAuthMode() { 
            authMode = authMode === 'login' ? 'register' : 'login'; 
            document.getElementById('authToggle').innerText = authMode === 'login' ? 'Chưa có tài khoản? Đăng ký' : 'Đã có tài khoản? Đăng nhập';
        }

        function logout() { localStorage.removeItem('tl_current'); location.reload(); }
        window.onload = () => { const s = localStorage.getItem('tl_current'); if(s) { currentUser = s; initApp(); } };
    </script>
</body>
</html>
