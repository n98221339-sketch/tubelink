<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tube Link - Multi-API System</title>
    <link rel="icon" href="https://i.ibb.co/rRNhv33x/screenshot.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { background-color: #0a0a0a; color: #fff; scroll-behavior: smooth; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .video-16-9 { position: relative; padding-bottom: 56.25%; height: 0; border-radius: 20px; overflow: hidden; background: #000; }
        .video-16-9 iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .video-card { transition: all 0.3s ease; }
        .video-card:hover { transform: translateY(-8px); }
        #authModal { background: rgba(0,0,0,0.9); backdrop-filter: blur(20px); }
        .history-item:hover .delete-btn { opacity: 1; }
        .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px border-purple-500; cursor: pointer; }
    </style>
</head>
<body>

    <input type="file" id="avatarFileInput" accept="image/*" class="hidden" onchange="handleFileSelect(this)">

    <div id="authModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="bg-zinc-900 border border-zinc-800 p-8 rounded-[32px] w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
                <img src="https://i.ibb.co/rRNhv33x/screenshot.png" class="w-16 h-16 mx-auto mb-4 rounded-2xl shadow-lg">
                <h2 id="authTitle" class="text-2xl font-bold text-white">Tube Link</h2>
                <p class="text-zinc-500 text-sm mt-2">Đăng nhập để lưu lịch sử</p>
            </div>
            <div class="space-y-4">
                <input id="authUser" type="text" placeholder="Tên người dùng..." class="w-full bg-black border border-zinc-700 p-4 rounded-2xl outline-none focus:border-purple-600 transition-all">
                <input id="authPass" type="password" placeholder="Mật khẩu..." class="w-full bg-black border border-zinc-700 p-4 rounded-2xl outline-none focus:border-purple-600 transition-all">
                <button onclick="handleAuth()" class="w-full bg-purple-600 hover:bg-purple-700 p-4 rounded-2xl font-bold transition-all">Xác nhận</button>
                <p class="text-center text-xs text-zinc-500 cursor-pointer" onclick="toggleAuthMode()" id="authToggle">Chưa có tài khoản? Đăng ký</p>
            </div>
        </div>
    </div>

    <nav class="fixed top-0 w-full bg-[#0a0a0a]/90 backdrop-blur-md border-b border-zinc-800/50 flex items-center justify-between px-6 py-4 z-50">
        <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
            <img src="https://i.ibb.co/rRNhv33x/screenshot.png" class="w-10 h-10 rounded-xl">
            <span class="text-xl font-black uppercase">Tube <span class="text-purple-500">Link</span></span>
        </div>
        <div class="flex-1 max-w-[500px] mx-4">
            <div class="flex bg-zinc-900 border border-zinc-800 rounded-2xl overflow-hidden focus-within:border-purple-500 transition-all">
                <input id="searchInput" type="text" placeholder="Tìm kiếm video..." class="w-full bg-transparent py-2 px-5 outline-none text-sm">
                <button onclick="handleSearch()" class="px-5 text-zinc-500 hover:text-purple-500"><i class="fas fa-search"></i></button>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 group relative">
                <img id="userAvatarImg" src="https://ui-avatars.com/api/?name=User&background=random" class="user-avatar" onclick="changeAvatar()">
                <span id="userNameDisplay" class="text-xs font-bold hidden sm:block"></span>
            </div>
            <button onclick="logout()" class="text-[10px] text-zinc-500 hover:text-red-500 font-bold uppercase">Thoát</button>
        </div>
    </nav>

    <main class="pt-28 px-6 max-w-[1400px] mx-auto pb-20">
        <div class="flex flex-col lg:flex-row gap-8">
            <div class="flex-1">
                <div id="playerSection" class="hidden mb-12">
                    <div class="video-16-9 shadow-2xl border border-zinc-800">
                        <iframe id="mainIframe" src="" frameborder="0" allowfullscreen allow="autoplay"></iframe>
                    </div>
                    <div class="mt-6 flex justify-between items-center">
                        <h1 id="vTitle" class="text-xl font-bold text-white"></h1>
                        <button onclick="switchServer()" class="bg-zinc-800 text-[10px] px-4 py-2 rounded-lg hover:bg-zinc-700 whitespace-nowrap ml-4">SERVER DỰ PHÒNG</button>
                    </div>
                </div>
                <div id="videoGrid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                <div id="pagination" class="hidden mt-12 flex justify-center gap-8">
                    <button id="prevBtn" onclick="changePage('prev')" class="px-6 py-3 rounded-xl bg-zinc-900 border border-zinc-800 hover:bg-purple-600 disabled:opacity-50">Trang trước</button>
                    <button id="nextBtn" onclick="changePage('next')" class="px-6 py-3 rounded-xl bg-zinc-900 border border-zinc-800 hover:bg-purple-600 disabled:opacity-50">Trang sau</button>
                </div>
            </div>

            <div class="w-full lg:w-[350px] space-y-6">
                <div class="bg-zinc-900/50 border border-zinc-800 p-6 rounded-[24px]">
                    <div class="flex justify-between mb-4"><span class="font-bold text-sm tracking-tighter">LỊCH SỬ XEM</span><button onclick="clearWatchHistory()" class="text-[10px] text-red-500 font-bold">XÓA HẾT</button></div>
                    <div id="historyList" class="space-y-4"></div>
                </div>
                <div class="bg-zinc-900/50 border border-zinc-800 p-6 rounded-[24px]">
                    <div class="flex justify-between mb-4"><span class="font-bold text-sm tracking-tighter">LỊCH SỬ TÌM KIẾM</span><button onclick="clearSearchHistory()" class="text-[10px] text-red-500 font-bold">XÓA HẾT</button></div>
                    <div id="searchHistoryList" class="space-y-2"></div>
                </div>
                <div class="text-[10px] text-zinc-600 text-center uppercase font-bold tracking-widest">API Status: <span id="apiKeyIndexText" class="text-purple-500">Key #1</span></div>
            </div>
        </div>
    </main>

    <script>
        const API_KEYS = [
            'AIzaSyAlPGJ5uNvGOqej7peEsMbLM-o0KTBIKpA',
            'AIzaSyDOdje8NKBfjxFXr0tx0XsogJCJ49aQHIY',
            'AIzaSyAaSUZ4qz9XyyQtqFROMfIjJX1XJBTxk_0',
            'AIzaSyBpcZownZn5LpKZmqG81Fjxq19LNM6w4Lc',
            'AIzaSyDDIyJl5Y3A-5VeItqc7Cm5pz1TVOeb60w',
            'AIzaSyDXUC00CO5eblahnmEZTxJDyKJgD_KGEMw',
            'AIzaSyCi9g8JfoczO0406S9Wptu8dY8vRoOcwh4'
        ];

        let currentKeyIndex = 0;
        let currentUser = null;
        let authMode = 'login';
        let currentQuery = 'Minecraft';
        let nextPageToken = '';
        let prevPageTokens = [];
        let currentVideoId = '';

        async function fetchYT(url) {
            const currentKey = API_KEYS[currentKeyIndex];
            try {
                const response = await fetch(`${url}&key=${currentKey}`);
                const data = await response.json();
                if (data.error && (data.error.code === 403 || data.error.message.toLowerCase().includes('quota'))) {
                    if (currentKeyIndex < API_KEYS.length - 1) {
                        currentKeyIndex++;
                        document.getElementById('apiKeyIndexText').innerText = `Key #${currentKeyIndex + 1}`;
                        return fetchYT(url);
                    } else {
                        throw new Error("Tất cả API Key đã hết hạn!");
                    }
                }
                return data;
            } catch (err) { throw err; }
        }

        async function handleSearch(query = null, token = '') {
            const q = query || document.getElementById('searchInput').value.trim();
            if(!q) return;
            currentQuery = q;
            if(!query && !token) saveSearchHistory(q);
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '<div class="col-span-full text-center py-10 text-zinc-500">Đang tải...</div>';
            try {
                const data = await fetchYT(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=12&q=${encodeURIComponent(q)}&type=video&pageToken=${token}`);
                if (data.items) {
                    nextPageToken = data.nextPageToken || '';
                    renderVideos(data.items);
                    document.getElementById('pagination').classList.remove('hidden');
                    document.getElementById('prevBtn').disabled = prevPageTokens.length === 0;
                    document.getElementById('nextBtn').disabled = !nextPageToken;
                }
            } catch (error) { grid.innerHTML = `<div class="text-red-500">${error.message}</div>`; }
        }

        function renderVideos(items) {
            document.getElementById('videoGrid').innerHTML = items.map(item => `
                <div class="video-card cursor-pointer group" onclick="playVideo('${item.id.videoId}', '${item.snippet.title.replace(/'/g, "\\'")}')">
                    <div class="relative aspect-video rounded-2xl overflow-hidden mb-3 border border-zinc-800">
                        <img src="${item.snippet.thumbnails.high.url}" class="w-full h-full object-cover group-hover:scale-105 transition-transform">
                    </div>
                    <h3 class="text-sm font-bold line-clamp-2 text-zinc-200 group-hover:text-purple-500">${item.snippet.title}</h3>
                </div>`).join('');
        }

        function playVideo(id, title) {
            currentVideoId = id;
            document.getElementById('playerSection').classList.remove('hidden');
            document.getElementById('vTitle').innerText = title;
            document.getElementById('mainIframe').src = `https://www.youtube.com/embed/${id}?autoplay=1`;
            saveWatchHistory(id, title);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function switchServer() {
            if(currentVideoId) document.getElementById('mainIframe').src = `https://www.youtube-nocookie.com/embed/${currentVideoId}?autoplay=1`;
        }

        function changePage(dir) {
            if(dir === 'next' && nextPageToken) { prevPageTokens.push(nextPageToken); handleSearch(currentQuery, nextPageToken); }
            else if(dir === 'prev' && prevPageTokens.length > 0) { prevPageTokens.pop(); handleSearch(currentQuery, prevPageTokens[prevPageTokens.length-1] || ''); }
        }

        // --- Profile Avatar (Cập nhật nhập link hoặc chọn file) ---
        function changeAvatar() {
            const choice = confirm("Nhấn 'OK' để dán LINK ảnh.\nNhấn 'Cancel' để TẢI ẢNH từ máy.");
            if(choice) {
                const newUrl = prompt("Nhập link ảnh avatar mới:");
                if(newUrl) updateAvatarStorage(newUrl);
            } else {
                document.getElementById('avatarFileInput').click();
            }
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    updateAvatarStorage(e.target.result);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateAvatarStorage(imgData) {
            let users = JSON.parse(localStorage.getItem('tl_users'));
            users[currentUser].avatar = imgData;
            localStorage.setItem('tl_users', JSON.stringify(users));
            document.getElementById('userAvatarImg').src = imgData;
        }

        // --- History & Auth ---
        function saveWatchHistory(id, title) {
            let users = JSON.parse(localStorage.getItem('tl_users'));
            let h = users[currentUser].watchHistory || [];
            h = [{id, title}, ...h.filter(v => v.id !== id)].slice(0, 20);
            users[currentUser].watchHistory = h;
            localStorage.setItem('tl_users', JSON.stringify(users));
            renderWatchHistory();
        }

        function renderWatchHistory() {
            const users = JSON.parse(localStorage.getItem('tl_users'));
            const history = users[currentUser].watchHistory || [];
            document.getElementById('historyList').innerHTML = history.map(v => `
                <div class="flex items-center gap-3 group history-item p-2 rounded-xl hover:bg-zinc-800 transition-colors">
                    <div class="flex-1 cursor-pointer flex gap-3 items-center" onclick="playVideo('${v.id}', '${v.title.replace(/'/g, "\\'")}')">
                        <img src="https://img.youtube.com/vi/${v.id}/default.jpg" class="w-12 rounded-lg">
                        <p class="text-[10px] line-clamp-2 text-zinc-400 font-medium">${v.title}</p>
                    </div>
                    <button onclick="deleteWatchItem('${v.id}')" class="delete-btn opacity-0 text-red-500 p-2"><i class="fas fa-times text-xs"></i></button>
                </div>`).join('') || '<p class="text-[10px] text-center text-zinc-700">Trống</p>';
        }

        function deleteWatchItem(id) {
            let users = JSON.parse(localStorage.getItem('tl_users'));
            users[currentUser].watchHistory = users[currentUser].watchHistory.filter(v => v.id !== id);
            localStorage.setItem('tl_users', JSON.stringify(users));
            renderWatchHistory();
        }

        function saveSearchHistory(q) {
            let users = JSON.parse(localStorage.getItem('tl_users'));
            let h = [q, ...(users[currentUser].searchHistory || []).filter(x => x !== q)].slice(0, 10);
            users[currentUser].searchHistory = h;
            localStorage.setItem('tl_users', JSON.stringify(users));
            renderSearchHistory();
        }

        function renderSearchHistory() {
            const users = JSON.parse(localStorage.getItem('tl_users'));
            const history = users[currentUser].searchHistory || [];
            document.getElementById('searchHistoryList').innerHTML = history.map(q => `
                <div class="flex justify-between items-center group history-item p-2 hover:bg-zinc-800 rounded-lg">
                    <span class="text-xs text-zinc-400 cursor-pointer" onclick="handleSearch('${q}')"><i class="fas fa-history mr-2 text-[9px]"></i>${q}</span>
                    <button onclick="deleteSearchItem('${q}')" class="delete-btn opacity-0 text-red-500"><i class="fas fa-times"></i></button>
                </div>`).join('') || '<p class="text-[10px] text-center text-zinc-700">Trống</p>';
        }

        function deleteSearchItem(q) {
            let users = JSON.parse(localStorage.getItem('tl_users'));
            users[currentUser].searchHistory = users[currentUser].searchHistory.filter(x => x !== q);
            localStorage.setItem('tl_users', JSON.stringify(users));
            renderSearchHistory();
        }

        function clearWatchHistory() { if(confirm("Xóa hết?")) { let u = JSON.parse(localStorage.getItem('tl_users')); u[currentUser].watchHistory = []; localStorage.setItem('tl_users', JSON.stringify(u)); renderWatchHistory(); }}
        function clearSearchHistory() { if(confirm("Xóa hết?")) { let u = JSON.parse(localStorage.getItem('tl_users')); u[currentUser].searchHistory = []; localStorage.setItem('tl_users', JSON.stringify(u)); renderSearchHistory(); }}

        function handleAuth() {
            const u = document.getElementById('authUser').value.trim();
            const p = document.getElementById('authPass').value.trim();
            if(!u || !p) return;
            let users = JSON.parse(localStorage.getItem('tl_users')) || {};
            if(authMode === 'register') {
                if(users[u]) return alert("Tên đã tồn tại!");
                users[u] = { pass: p, watchHistory: [], searchHistory: [], avatar: `https://ui-avatars.com/api/?name=${u}&background=random` };
                localStorage.setItem('tl_users', JSON.stringify(users));
                alert("Đã đăng ký!"); toggleAuthMode();
            } else {
                if(users[u] && users[u].pass === p) { currentUser = u; localStorage.setItem('tl_current', u); initApp(); }
                else alert("Sai thông tin!");
            }
        }

        function initApp() {
            const users = JSON.parse(localStorage.getItem('tl_users'));
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('userNameDisplay').innerText = currentUser;
            document.getElementById('userAvatarImg').src = users[currentUser].avatar || `https://ui-avatars.com/api/?name=${currentUser}&background=random`;
            renderWatchHistory(); renderSearchHistory(); handleSearch('Minecraft');
        }

        function toggleAuthMode() { 
            authMode = authMode === 'login' ? 'register' : 'login'; 
            document.getElementById('authTitle').innerText = authMode === 'login' ? 'Tube Link' : 'Tạo acc mới'; 
            document.getElementById('authToggle').innerText = authMode === 'login' ? 'Chưa có tài khoản? Đăng ký' : 'Đã có tài khoản? Đăng nhập';
        }

        function logout() { localStorage.removeItem('tl_current'); location.reload(); }
        window.onload = () => { const s = localStorage.getItem('tl_current'); if(s) { currentUser = s; initApp(); } };
        document.getElementById('searchInput').addEventListener('keypress', e => { if(e.key === 'Enter') handleSearch(); });
    </script>
</body>
</html>
