<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tube Link Pro - Dashboard Edition</title>
    <link rel="icon" href="https://i.ibb.co/rRNhv33x/screenshot.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        body {
            background-color: #09090b;
            color: #fafafa;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .purple-gradient {
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
        }

        .glass-card {
            background: rgba(24, 24, 27, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(168, 85, 247, 0.1);
        }

        .video-16-9 {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            border-radius: 24px;
            overflow: hidden;
            background: #000;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .video-16-9 iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast-item {
            animation: slideIn 0.3s ease-out forwards;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #a855f7; }

        .api-btn-active {
            background: #a855f7 !important;
            color: white !important;
            border-color: #a855f7 !important;
        }

        .modal-open { display: flex !important; }

        /* Pagination fix */
        #pagination { display: none; }
        #pagination.visible { display: flex; }
    </style>
</head>

<body>

    <div id="toastContainer" class="fixed bottom-5 right-5 z-[1000] flex flex-col gap-3"></div>

    <!-- Profile Modal -->
    <div id="profileModal" class="fixed inset-0 z-[200] hidden items-center justify-center p-4 bg-black/80 backdrop-blur-md">
        <div class="glass-card w-full max-w-md p-8 rounded-[32px] shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-extrabold uppercase tracking-tighter">C√†i ƒë·∫∑t <span class="text-purple-500">H·ªì S∆°</span></h3>
                <button onclick="toggleProfileModal()" class="text-zinc-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-6">
                <div class="flex flex-col items-center gap-4">
                    <img id="modalAvatarPreview" src="" class="w-24 h-24 rounded-full border-4 border-purple-500 object-cover shadow-lg shadow-purple-500/20">
                    <div class="flex gap-2">
                        <button onclick="document.getElementById('avatarFileInput').click()" class="text-[10px] bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded-full font-bold transition-all">CH·ªåN FILE</button>
                        <input type="file" id="avatarFileInput" accept="image/*" class="hidden" onchange="handleFileSelect(this)">
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-zinc-500 ml-2 uppercase">T√™n hi·ªÉn th·ªã</label>
                        <input id="editUserName" type="text" class="w-full bg-zinc-950 border border-zinc-800 p-4 rounded-2xl outline-none focus:border-purple-500 transition-all text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-zinc-500 ml-2 uppercase">Link ·∫£nh ƒë·∫°i di·ªán</label>
                        <input id="editAvatarUrl" type="text" placeholder="https://..." class="w-full bg-zinc-950 border border-zinc-800 p-4 rounded-2xl outline-none focus:border-purple-500 transition-all text-sm">
                    </div>
                    <!-- YouTube Channel Link -->
                    <div>
                        <label class="text-[10px] font-bold text-zinc-500 ml-2 uppercase">Link k√™nh YouTube</label>
                        <div class="flex gap-2">
                            <input id="editYtChannel" type="text" placeholder="https://youtube.com/@channel..." class="w-full bg-zinc-950 border border-zinc-800 p-4 rounded-2xl outline-none focus:border-purple-500 transition-all text-sm">
                            <button onclick="openYtChannel()" class="bg-red-600 hover:bg-red-700 px-4 py-3 rounded-2xl text-white transition-all" title="M·ªü k√™nh YT"><i class="fab fa-youtube"></i></button>
                        </div>
                        <p class="text-[9px] text-zinc-600 mt-1 ml-2">L∆∞u link k√™nh YT ƒë·ªÉ truy c·∫≠p nhanh</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="saveProfile()" class="flex-1 purple-gradient p-4 rounded-2xl font-bold shadow-lg shadow-purple-500/30 hover:scale-[1.02] active:scale-95 transition-all">L∆ØU THAY ƒê·ªîI</button>
                    <button onclick="exportBackup()" class="bg-zinc-800 hover:bg-zinc-700 px-5 py-4 rounded-2xl font-bold transition-all text-[11px]" title="Sao l∆∞u t√†i kho·∫£n"><i class="fas fa-download mr-1"></i>SAO L∆ØU</button>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-zinc-500 ml-2 uppercase">Kh√¥i ph·ª•c t√†i kho·∫£n</label>
                    <div class="flex gap-2 mt-2">
                        <button onclick="document.getElementById('importFileInput').click()" class="flex-1 bg-zinc-900 border border-zinc-700 hover:border-purple-500 p-3 rounded-2xl font-bold transition-all text-[10px]"><i class="fas fa-upload mr-1"></i>IMPORT FILE SAO L∆ØU</button>
                        <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="importBackup(this)">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-[#09090b]">
        <div class="bg-zinc-900/50 border border-zinc-800 p-10 rounded-[40px] w-full max-w-md shadow-2xl text-center">
            <img src="https://i.ibb.co/rRNhv33x/screenshot.png" class="w-20 h-20 mx-auto mb-6 rounded-3xl shadow-2xl">
            <h2 id="authTitle" class="text-3xl font-black mb-8 tracking-tighter uppercase">Tube <span class="text-purple-500">Link</span></h2>
            <div class="space-y-4">
                <input id="authUser" type="text" placeholder="T√™n ƒëƒÉng nh·∫≠p" class="w-full bg-black border border-zinc-800 p-4 rounded-2xl outline-none focus:border-purple-600 transition-all text-sm" onkeydown="if(event.key==='Enter') handleAuth()">
                <input id="authPass" type="password" placeholder="M·∫≠t kh·∫©u" class="w-full bg-black border border-zinc-800 p-4 rounded-2xl outline-none focus:border-purple-600 transition-all text-sm" onkeydown="if(event.key==='Enter') handleAuth()">
                <button onclick="handleAuth()" class="w-full purple-gradient p-4 rounded-2xl font-bold shadow-lg shadow-purple-500/20 hover:opacity-90 transition-all">TI·∫æP T·ª§C</button>
                <p class="text-zinc-500 text-xs mt-4 cursor-pointer hover:text-purple-400 transition-all" onclick="toggleAuthMode()" id="authToggle">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</p>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="fixed top-0 w-full bg-[#09090b]/80 backdrop-blur-xl border-b border-zinc-800/50 flex items-center justify-between px-8 py-4 z-50">
        <div class="flex items-center gap-3 cursor-pointer group" onclick="goHome()">
            <div class="p-2 bg-purple-500/10 rounded-xl group-hover:bg-purple-500/20 transition-all">
                <img src="https://i.ibb.co/rRNhv33x/screenshot.png" class="w-8 h-8 rounded-lg">
            </div>
            <span class="text-xl font-black uppercase tracking-tighter hidden md:block">Tube <span class="text-purple-500">Link</span></span>
        </div>

        <div class="flex-1 max-w-xl mx-8 relative">
            <div class="flex bg-zinc-900/50 border border-zinc-800 rounded-full px-5 py-2 focus-within:border-purple-500/50 transition-all">
                <input id="searchInput" type="text" placeholder="Kh√°m ph√° video b·∫°n y√™u th√≠ch..." class="w-full bg-transparent outline-none text-sm py-1"
                    onkeydown="if(event.key==='Enter') { handleSearch(); hideSearchHistory(); } else if(event.key==='Escape') hideSearchHistory();"
                    oninput="filterSearchHistory(this.value)"
                    onfocus="showSearchHistory()">
                <button onclick="handleSearch(); hideSearchHistory();" class="text-zinc-500 hover:text-purple-500"><i class="fas fa-search"></i></button>
            </div>
            <!-- Search History Dropdown -->
            <div id="searchHistoryDropdown" class="hidden absolute top-full left-0 right-0 mt-2 bg-zinc-900 border border-zinc-800 rounded-2xl shadow-2xl z-[300] overflow-hidden">
                <div class="flex justify-between items-center px-4 pt-3 pb-2 border-b border-zinc-800">
                    <span class="text-[10px] font-black tracking-widest text-zinc-500 uppercase">L·ªãch s·ª≠ t√¨m ki·∫øm</span>
                    <div class="flex items-center gap-3">
                        <button onclick="clearAllSearchHistory()" class="text-[10px] text-zinc-600 hover:text-red-500 font-bold transition-all">X√ìA T·∫§T C·∫¢</button>
                        <button onclick="hideSearchHistoryNow()" class="text-zinc-600 hover:text-white transition-all text-sm leading-none" title="ƒê√≥ng"><i class="fas fa-times"></i></button>
                    </div>
                </div>
                <div id="searchHistoryList" class="max-h-64 overflow-y-auto py-2"></div>
            </div>
        </div>

        <div class="flex items-center gap-6">
            <!-- YT Channel Quick Link -->
            <button id="ytChannelBtn" onclick="openYtChannel()" class="hidden text-red-500 hover:text-red-400 transition-all" title="M·ªü k√™nh YouTube c·ªßa b·∫°n">
                <i class="fab fa-youtube text-xl"></i>
            </button>
            <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-all" onclick="toggleProfileModal()">
                <div class="text-right hidden sm:block">
                    <p id="userNameDisplay" class="text-[11px] font-black uppercase tracking-wider leading-none"></p>
                    <span class="text-[9px] text-purple-500 font-bold">PRO MEMBER</span>
                </div>
                <img id="userAvatarImg" src="" class="w-10 h-10 rounded-full object-cover border-2 border-purple-500/30 p-0.5">
            </div>
            <button onclick="logout()" class="text-zinc-600 hover:text-red-500 transition-all" title="ƒêƒÉng xu·∫•t"><i class="fas fa-power-off"></i></button>
        </div>
    </nav>

    <!-- Main -->
    <main class="pt-28 px-8 max-w-[1600px] mx-auto pb-20">
        <div class="flex flex-col lg:flex-row gap-10">
            <div class="flex-1">
                <!-- Player -->
                <div id="playerSection" class="hidden mb-12">
                    <div class="video-16-9">
                        <iframe id="mainIframe" src="" frameborder="0" allowfullscreen allow="autoplay; encrypted-media"></iframe>
                    </div>
                    <div class="mt-8 flex justify-between items-start gap-4 flex-wrap">
                        <div>
                            <h1 id="vTitle" class="text-2xl font-black text-white leading-tight mb-2"></h1>
                            <div class="flex gap-2 flex-wrap">
                                <span class="px-3 py-1 bg-zinc-900 rounded-full text-[10px] font-bold text-zinc-400 border border-zinc-800">4K ULTRA HD</span>
                                <span class="px-3 py-1 bg-purple-500/10 rounded-full text-[10px] font-bold text-purple-400 border border-purple-500/20">PREMIUM SERVER</span>
                                <a id="openOnYT" href="#" target="_blank" class="px-3 py-1 bg-red-600/10 rounded-full text-[10px] font-bold text-red-400 border border-red-500/20 hover:bg-red-600/20 transition-all"><i class="fab fa-youtube mr-1"></i>M·ªü tr√™n YouTube</a>
                            </div>
                        </div>
                        <button onclick="switchServer()" class="bg-zinc-900 border border-zinc-800 text-[10px] px-6 py-3 rounded-2xl hover:bg-zinc-800 font-black uppercase tracking-widest transition-all">
                            <i class="fas fa-server mr-2"></i>Chuy·ªÉn Server D·ª± Ph√≤ng
                        </button>
                    </div>
                </div>

                <!-- Grid -->
                <div id="videoGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8"></div>

                <!-- Pagination - FIXED: removed conflicting hidden+flex -->
                <div id="pagination" class="mt-16 justify-center items-center gap-10">
                    <button id="prevBtn" onclick="changePage('prev')" class="p-4 rounded-2xl bg-zinc-900 border border-zinc-800 hover:border-purple-500 disabled:opacity-20 transition-all"><i class="fas fa-chevron-left mr-2"></i> TR∆Ø·ªöC</button>
                    <span id="pageInfo" class="text-xs font-bold text-zinc-500 uppercase tracking-widest">Trang <span id="pageNum">1</span></span>
                    <button id="nextBtn" onclick="changePage('next')" class="p-4 rounded-2xl bg-zinc-900 border border-zinc-800 hover:border-purple-500 disabled:opacity-20 transition-all">TI·∫æP THEO <i class="fas fa-chevron-right ml-2"></i></button>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="w-full lg:w-[380px] space-y-8">
                <!-- API Panel -->
                <div class="glass-card p-6 rounded-[32px] space-y-6">
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-black tracking-widest text-zinc-500 uppercase">H·ªá th·ªëng API</span>
                        <div id="apiStatusIndicator" class="flex items-center gap-2 text-[10px] text-green-500 font-bold">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> ONLINE
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between text-[10px] font-bold text-zinc-500 uppercase px-1">
                            <span>Ch·ªçn Server (1-10)</span>
                            <span id="currentKeyLabel" class="text-purple-500">SERVER #1</span>
                        </div>
                        <div id="serverGrid" class="grid grid-cols-5 gap-2"></div>
                    </div>

                    <div class="pt-4 border-t border-zinc-800/50 space-y-4">
                        <div class="flex items-center justify-between bg-zinc-950 p-3 rounded-2xl border border-zinc-800">
                            <span class="text-[11px] font-bold text-zinc-400">Ch·∫ø ƒë·ªô API C√° Nh√¢n</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="apiToggle" class="sr-only peer" onchange="toggleApiMode()">
                                <div class="w-10 h-5 bg-zinc-800 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600 peer-checked:after:bg-white"></div>
                            </label>
                        </div>

                        <div id="personalInputZone" class="hidden space-y-3">
                            <input id="newPersonalKey" type="text" placeholder="D√°n API Key c·ªßa b·∫°n..." class="w-full bg-black border border-zinc-800 p-3 rounded-xl text-[10px] outline-none focus:border-purple-500 transition-all">
                            <button onclick="addPersonalKey()" class="w-full py-3 bg-purple-600/10 text-purple-500 rounded-xl text-[10px] font-bold border border-purple-500/20 hover:bg-purple-600/20 transition-all">+ L∆ØU V√ÄO DANH S√ÅCH</button>
                            <div id="personalKeysContainer" class="max-h-32 overflow-y-auto space-y-2 pr-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Watch History -->
                <div class="glass-card p-6 rounded-[32px]">
                    <div class="flex justify-between items-center mb-6">
                        <span class="text-xs font-black tracking-widest text-zinc-500 uppercase">L·ªãch s·ª≠ xem</span>
                        <button onclick="clearWatchHistory()" class="text-[10px] text-zinc-600 hover:text-red-500 font-bold transition-all"><i class="fas fa-trash mr-1"></i>X√ìA T·∫§T C·∫¢</button>
                    </div>
                    <div id="historyList" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const SYSTEM_KEYS = [
            'AIzaSyAlPGJ5uNvGOqej7peEsMbLM-o0KTBIKpA', 'AIzaSyDOdje8NKBfjxFXr0tx0XsogJCJ49aQHIY',
            'AIzaSyAaSUZ4qz9XyyQtqFROMfIjJX1XJBTxk_0', 'AIzaSyBpcZownZn5LpKZmqG81Fjxq19LNM6w4Lc',
            'AIzaSyDDIyJl5Y3A-5VeItqc7Cm5pz1TVOeb60w', 'AIzaSyDXUC00CO5eblahnmEZTxJDyKJgD_KGEMw',
            'AIzaSyCi9g8JfoczO0406S9Wptu8dY8vRoOcwh4', 'AIzaSyD03V_D_18WEx_G7L_Yp5J4E0X9812M1A',
            'AIzaSyB8K_X_J9K_W_P10_Example_Actual_9', 'AIzaSyC10_L_M_O_P_Example_Actual_10'
        ];

        let currentKeyIndex = 0;
        let currentUser = null;
        let authMode = 'login';
        let currentQuery = 'Minecraft Music';
        let nextPageToken = '';
        let prevPageTokens = [];
        let currentPage = 1;
        let currentVideoId = '';
        let personalKeys = [];
        let usePersonal = false;

        // ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ
        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'fa-check-circle' : (type === 'error' ? 'fa-exclamation-triangle' : 'fa-info-circle');
            const color = type === 'success' ? 'text-green-500' : (type === 'error' ? 'text-red-500' : 'text-purple-500');
            toast.className = `toast-item glass-card px-6 py-4 rounded-2xl flex items-center gap-4 min-w-[280px] shadow-2xl border-l-4 ${type === 'success' ? 'border-l-green-500' : (type === 'error' ? 'border-l-red-500' : 'border-l-purple-500')}`;
            toast.innerHTML = `<i class="fas ${icon} ${color} text-lg"></i><div class="flex-1"><p class="text-xs font-bold text-white">${msg}</p></div>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ‚îÄ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ
        function toggleProfileModal() {
            const modal = document.getElementById('profileModal');
            if (!modal.classList.contains('modal-open')) {
                const users = JSON.parse(localStorage.getItem('tl_users') || '{}');
                const user = users[currentUser] || {};
                document.getElementById('editUserName').value = currentUser;
                document.getElementById('editAvatarUrl').value = user.avatar || '';
                document.getElementById('editYtChannel').value = user.ytChannel || '';
                document.getElementById('modalAvatarPreview').src = user.avatar || `https://ui-avatars.com/api/?name=${currentUser}&background=a855f7&color=fff`;
                modal.classList.add('modal-open');
            } else {
                modal.classList.remove('modal-open');
            }
        }

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('modalAvatarPreview').src = e.target.result;
                    document.getElementById('editAvatarUrl').value = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProfile() {
            const newName = document.getElementById('editUserName').value.trim();
            const newAvatar = document.getElementById('modalAvatarPreview').src;
            const newYtChannel = document.getElementById('editYtChannel').value.trim();

            if (!newName) return showToast("T√™n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng", "error");

            let users = JSON.parse(localStorage.getItem('tl_users') || '{}');

            if (newName !== currentUser) {
                if (users[newName]) return showToast("T√™n n√†y ƒë√£ t·ªìn t·∫°i!", "error");
                users[newName] = users[currentUser];
                delete users[currentUser];
                localStorage.setItem('tl_current', newName);
                currentUser = newName;
            }

            users[currentUser].avatar = newAvatar;
            users[currentUser].ytChannel = newYtChannel;
            localStorage.setItem('tl_users', JSON.stringify(users));

            initApp();
            toggleProfileModal();
            showToast("C·∫≠p nh·∫≠t h·ªì s∆° th√†nh c√¥ng!", "success");
        }

        function openYtChannel() {
            const users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            const ch = (users[currentUser] || {}).ytChannel || document.getElementById('editYtChannel').value.trim();
            if (!ch) return showToast("Ch∆∞a c√≥ link k√™nh YouTube!", "error");
            window.open(ch, '_blank');
        }

        // ‚îÄ‚îÄ‚îÄ BACKUP / RESTORE ‚îÄ‚îÄ‚îÄ
        function exportBackup() {
            const users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            const userData = { user: currentUser, data: users[currentUser] };
            const blob = new Blob([JSON.stringify(userData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tubelink_backup_${currentUser}_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast("ƒê√£ xu·∫•t file sao l∆∞u!", "success");
        }

        function importBackup(input) {
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (!backup.user || !backup.data) throw new Error("File kh√¥ng h·ª£p l·ªá");
                    let users = JSON.parse(localStorage.getItem('tl_users') || '{}');
                    users[backup.user] = backup.data;
                    localStorage.setItem('tl_users', JSON.stringify(users));
                    showToast(`ƒê√£ kh√¥i ph·ª•c t√†i kho·∫£n: ${backup.user}`, "success");
                    // Switch to restored user
                    currentUser = backup.user;
                    localStorage.setItem('tl_current', currentUser);
                    toggleProfileModal();
                    initApp();
                } catch (err) {
                    showToast("File sao l∆∞u kh√¥ng h·ª£p l·ªá!", "error");
                }
            };
            reader.readAsText(input.files[0]);
            input.value = '';
        }

        // ‚îÄ‚îÄ‚îÄ SERVER GRID ‚îÄ‚îÄ‚îÄ
        function renderServerGrid() {
            const grid = document.getElementById('serverGrid');
            grid.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const btn = document.createElement('button');
                btn.className = `p-2 text-[10px] font-bold border border-zinc-800 rounded-lg bg-zinc-950 hover:border-purple-500 transition-all ${!usePersonal && currentKeyIndex === i ? 'api-btn-active' : ''}`;
                btn.innerText = i + 1;
                btn.onclick = () => selectServer(i);
                grid.appendChild(btn);
            }
        }

        function selectServer(index) {
            if (usePersonal) {
                showToast("Vui l√≤ng t·∫Øt 'API C√° Nh√¢n' ƒë·ªÉ ch·ªçn Server h·ªá th·ªëng", "info");
                return;
            }
            currentKeyIndex = index;
            document.getElementById('currentKeyLabel').innerText = `SERVER #${index + 1}`;
            renderServerGrid();
            handleSearch(currentQuery);
            showToast(`ƒê√£ chuy·ªÉn sang Server #${index + 1}`, "success");
        }

        // ‚îÄ‚îÄ‚îÄ SWITCH SERVER (backup) - FIXED ‚îÄ‚îÄ‚îÄ
        function switchServer() {
            if (!usePersonal) {
                // Auto pick next server
                const nextIndex = (currentKeyIndex + 1) % 10;
                selectServer(nextIndex);
            } else {
                // Cycle personal keys
                const keys = personalKeys;
                if (keys.length < 2) return showToast("C·∫ßn √≠t nh·∫•t 2 API key c√° nh√¢n ƒë·ªÉ chuy·ªÉn server", "info");
                currentKeyIndex = (currentKeyIndex + 1) % keys.length;
                showToast(`ƒê√£ chuy·ªÉn sang Key c√° nh√¢n #${currentKeyIndex + 1}`, "success");
                handleSearch(currentQuery);
            }
        }

        // ‚îÄ‚îÄ‚îÄ API FETCH ‚îÄ‚îÄ‚îÄ
        async function fetchYT(url) {
            const keys = (usePersonal && personalKeys.length > 0) ? personalKeys : SYSTEM_KEYS;
            const currentKey = keys[currentKeyIndex] || keys[0];
            try {
                const response = await fetch(`${url}&key=${currentKey}`);
                const data = await response.json();
                if (data.error) {
                    const isQuota = data.error.code === 403;
                    showToast(isQuota ? "Server n√†y h·∫øt h·∫°n m·ª©c, vui l√≤ng ƒë·ªïi server!" : data.error.message, "error");
                    document.getElementById('apiStatusIndicator').innerHTML = '<span class="w-2 h-2 bg-red-500 rounded-full"></span> <span class="text-red-500">ERROR</span>';
                    return { items: [] };
                }
                document.getElementById('apiStatusIndicator').innerHTML = '<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> <span class="text-green-500">ONLINE</span>';
                return data;
            } catch (err) {
                showToast("L·ªói k·∫øt n·ªëi m·∫°ng!", "error");
                return { items: [] };
            }
        }

        // ‚îÄ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ
        async function handleSearch(query = null, token = '') {
            const q = query || document.getElementById('searchInput').value.trim();
            if (!q) return;
            saveSearchHistory(q);

            currentQuery = q;
            document.getElementById('searchInput').value = q;

            const grid = document.getElementById('videoGrid');
            grid.innerHTML = '<div class="col-span-full text-center py-20 opacity-50"><i class="fas fa-spinner fa-spin text-3xl text-purple-500 mb-4"></i><p class="text-xs font-bold tracking-widest uppercase mt-4">ƒêang t√¨m ki·∫øm...</p></div>';

            const data = await fetchYT(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=12&q=${encodeURIComponent(q)}&type=video&pageToken=${token}`);

            if (data && data.items && data.items.length > 0) {
                nextPageToken = data.nextPageToken || '';
                renderVideos(data.items);
                const pagination = document.getElementById('pagination');
                pagination.classList.add('visible');
                document.getElementById('prevBtn').disabled = prevPageTokens.length === 0;
                document.getElementById('nextBtn').disabled = !nextPageToken;
                document.getElementById('pageNum').innerText = currentPage;
            } else {
                grid.innerHTML = '<div class="col-span-full text-center py-20 text-red-500 font-bold uppercase text-xs">Kh√¥ng c√≥ k·∫øt qu·∫£ ho·∫∑c Server l·ªói.<br><span class="text-zinc-500 normal-case text-[11px] mt-2 block">H√£y th·ª≠ ƒë·ªïi server ho·∫∑c ki·ªÉm tra API key</span></div>';
                document.getElementById('pagination').classList.remove('visible');
            }
        }

        // ‚îÄ‚îÄ‚îÄ PAGINATION - FIXED ‚îÄ‚îÄ‚îÄ
        function changePage(dir) {
            if (dir === 'next' && nextPageToken) {
                prevPageTokens.push(nextPageToken);
                currentPage++;
                handleSearch(currentQuery, nextPageToken);
            } else if (dir === 'prev' && prevPageTokens.length > 0) {
                // Go back: prevPageTokens holds NEXT tokens, we need to track prev tokens properly
                prevPageTokens.pop(); // remove current
                const token = prevPageTokens.length > 0 ? prevPageTokens[prevPageTokens.length - 1] : '';
                currentPage--;
                // Reset and re-search with correct token
                handleSearch(currentQuery, prevPageTokens.pop() || '');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ‚îÄ‚îÄ‚îÄ RENDER VIDEOS ‚îÄ‚îÄ‚îÄ
        function renderVideos(items) {
            document.getElementById('videoGrid').innerHTML = items.map(item => {
                const id = item.id.videoId;
                const title = item.snippet.title.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const thumb = item.snippet.thumbnails.high?.url || item.snippet.thumbnails.default?.url;
                const channel = item.snippet.channelTitle;
                return `
                <div class="video-card cursor-pointer group" onclick="playVideo('${id}', '${title}')">
                    <div class="relative aspect-video rounded-[24px] overflow-hidden mb-4 border border-zinc-800 group-hover:border-purple-500/50 transition-all shadow-lg">
                        <img src="${thumb}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" loading="lazy">
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-all">
                            <i class="fas fa-play text-white text-3xl drop-shadow-lg"></i>
                        </div>
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-all">
                            <a href="https://www.youtube.com/watch?v=${id}" target="_blank" onclick="event.stopPropagation()" class="bg-red-600 hover:bg-red-700 text-white text-[9px] px-2 py-1 rounded-full font-bold"><i class="fab fa-youtube mr-1"></i>YT</a>
                        </div>
                    </div>
                    <h3 class="text-sm font-bold line-clamp-2 text-zinc-300 group-hover:text-purple-400 transition-all">${item.snippet.title}</h3>
                    <p class="text-[10px] text-zinc-600 mt-1 font-bold uppercase tracking-tighter">${channel}</p>
                </div>`;
            }).join('');
        }

        // ‚îÄ‚îÄ‚îÄ PLAY VIDEO ‚îÄ‚îÄ‚îÄ
        function playVideo(id, title) {
            currentVideoId = id;
            document.getElementById('playerSection').classList.remove('hidden');
            const cleanTitle = title.replace(/&quot;/g, '"').replace(/\\'/g, "'");
            document.getElementById('vTitle').innerText = cleanTitle;
            document.getElementById('mainIframe').src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`;
            document.getElementById('openOnYT').href = `https://www.youtube.com/watch?v=${id}`;
            saveWatchHistory(id, cleanTitle);
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showToast("‚ñ∂ " + cleanTitle.substring(0, 35) + "...", "info");
        }

        // ‚îÄ‚îÄ‚îÄ API MODE ‚îÄ‚îÄ‚îÄ
        function toggleApiMode() {
            usePersonal = document.getElementById('apiToggle').checked;
            document.getElementById('personalInputZone').classList.toggle('hidden', !usePersonal);
            currentKeyIndex = 0;
            renderServerGrid();
            document.getElementById('currentKeyLabel').innerText = usePersonal ? "PERSONAL API" : "SERVER #1";
            handleSearch(currentQuery);
            showToast(usePersonal ? "ƒê√£ b·∫≠t API c√° nh√¢n" : "ƒê√£ quay l·∫°i Server h·ªá th·ªëng", "info");
        }

        function addPersonalKey() {
            const input = document.getElementById('newPersonalKey');
            const key = input.value.trim();
            if (!key) return showToast("Vui l√≤ng nh·∫≠p API key", "error");
            if (personalKeys.includes(key)) return showToast("Key n√†y ƒë√£ t·ªìn t·∫°i!", "error");
            personalKeys.push(key);
            input.value = '';
            saveToLocal();
            renderPersonalKeys();
            showToast("ƒê√£ th√™m API m·ªõi!", "success");
        }

        function renderPersonalKeys() {
            const container = document.getElementById('personalKeysContainer');
            if (personalKeys.length === 0) {
                container.innerHTML = '<div class="text-[9px] text-zinc-700 text-center py-2">Ch∆∞a c√≥ API key c√° nh√¢n</div>';
                return;
            }
            container.innerHTML = personalKeys.map((k, i) => `
                <div class="flex items-center justify-between bg-black/40 p-3 rounded-xl border border-zinc-800 text-[9px] hover:border-purple-500/30 transition-all">
                    <span class="truncate w-48 text-zinc-500 font-mono">${k.substring(0, 20)}...</span>
                    <button onclick="removePersonalKey(${i})" class="text-zinc-600 hover:text-red-500 ml-2"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        function removePersonalKey(i) {
            personalKeys.splice(i, 1);
            saveToLocal();
            renderPersonalKeys();
            showToast("ƒê√£ x√≥a API", "info");
        }

        // ‚îÄ‚îÄ‚îÄ LOCAL STORAGE ‚îÄ‚îÄ‚îÄ
        function saveToLocal() {
            let users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            if (!users[currentUser]) return;
            users[currentUser].personalKeys = personalKeys;
            localStorage.setItem('tl_users', JSON.stringify(users));
        }

        // ‚îÄ‚îÄ‚îÄ WATCH HISTORY ‚îÄ‚îÄ‚îÄ
        function saveWatchHistory(id, title) {
            let users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            if (!users[currentUser]) return;
            let history = users[currentUser].watchHistory || [];
            history = history.filter(v => v.id !== id);
            history.unshift({ id, title, ts: Date.now() });
            if (history.length > 15) history.pop();
            users[currentUser].watchHistory = history;
            localStorage.setItem('tl_users', JSON.stringify(users));
            renderHistory();
        }

        function clearWatchHistory() {
            if (!confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠ xem?")) return;
            let users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            if (!users[currentUser]) return;
            users[currentUser].watchHistory = [];
            localStorage.setItem('tl_users', JSON.stringify(users));
            renderHistory();
            showToast("ƒê√£ x√≥a l·ªãch s·ª≠ xem", "success");
        }

        // ‚îÄ‚îÄ‚îÄ X√ìAT·ª™NG VIDEO L·ªäCH S·ª¨ - NEW ‚îÄ‚îÄ‚îÄ
        function removeFromHistory(id, e) {
            e.stopPropagation();
            let users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            if (!users[currentUser]) return;
            users[currentUser].watchHistory = (users[currentUser].watchHistory || []).filter(v => v.id !== id);
            localStorage.setItem('tl_users', JSON.stringify(users));
            renderHistory();
            showToast("ƒê√£ x√≥a kh·ªèi l·ªãch s·ª≠", "info");
        }

        function renderHistory() {
            let users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            let history = (users[currentUser] || {}).watchHistory || [];
            const list = document.getElementById('historyList');
            if (history.length === 0) {
                list.innerHTML = '<div class="text-center text-zinc-700 text-[10px] font-bold py-4">CH∆ØA C√ì D·ªÆ LI·ªÜU</div>';
                return;
            }
            list.innerHTML = history.map(v => `
                <div class="group flex items-center gap-3 p-2 hover:bg-zinc-900 rounded-xl transition-all cursor-pointer" onclick="playVideo('${v.id}', '${v.title.replace(/'/g, "\\'")}')">
                    <div class="w-2 h-2 rounded-full bg-zinc-800 group-hover:bg-purple-500 transition-all flex-shrink-0"></div>
                    <div class="text-[11px] text-zinc-500 truncate group-hover:text-zinc-200 font-bold flex-1">${v.title}</div>
                    <button onclick="removeFromHistory('${v.id}', event)" class="opacity-0 group-hover:opacity-100 text-zinc-700 hover:text-red-500 transition-all text-[10px] flex-shrink-0">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }


        // ‚îÄ‚îÄ‚îÄ SEARCH HISTORY ‚îÄ‚îÄ‚îÄ
        function saveSearchHistory(q) {
            let users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            if (!users[currentUser]) return;
            let sh = users[currentUser].searchHistory || [];
            sh = sh.filter(s => s !== q);
            sh.unshift(q);
            if (sh.length > 20) sh.pop();
            users[currentUser].searchHistory = sh;
            localStorage.setItem('tl_users', JSON.stringify(users));
        }
        function getSearchHistory() {
            const users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            return (users[currentUser] || {}).searchHistory || [];
        }
        function removeSearchHistoryItem(q, e) {
            e.stopPropagation();
            let users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            if (!users[currentUser]) return;
            users[currentUser].searchHistory = (users[currentUser].searchHistory || []).filter(s => s !== q);
            localStorage.setItem('tl_users', JSON.stringify(users));
            renderSearchHistoryDropdown(document.getElementById('searchInput').value);
        }
        function clearAllSearchHistory() {
            let users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            if (!users[currentUser]) return;
            users[currentUser].searchHistory = [];
            localStorage.setItem('tl_users', JSON.stringify(users));
            hideSearchHistory();
            showToast("ƒê√£ x√≥a l·ªãch s·ª≠ t√¨m ki·∫øm", "success");
        }
        function renderSearchHistoryDropdown(filter) {
            filter = filter || '';
            const list = document.getElementById('searchHistoryList');
            let history = getSearchHistory();
            if (filter) history = history.filter(s => s.toLowerCase().includes(filter.toLowerCase()));
            if (history.length === 0) {
                list.innerHTML = '<div class="text-[10px] text-zinc-700 text-center py-4 font-bold">CH∆ØA C√ì L·ªäCH S·ª¨ T√åM KI·∫æM</div>';
                return;
            }
            list.innerHTML = history.map(function(q) {
                var safe = q.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                return '<div class="group flex items-center gap-3 px-4 py-2 hover:bg-zinc-800 cursor-pointer transition-all" onclick="selectSearchHistory(decodeURIComponent(\'' + encodeURIComponent(q) + '\'))">'
                    + '<i class="fas fa-history text-zinc-600 text-[11px] flex-shrink-0"></i>'
                    + '<span class="text-[12px] text-zinc-400 group-hover:text-white flex-1 truncate">' + q + '</span>'
                    + '<button onclick="removeFromSH(decodeURIComponent(\'' + encodeURIComponent(q) + '\'), event)" class="opacity-0 group-hover:opacity-100 text-zinc-600 hover:text-red-500 transition-all text-[10px] flex-shrink-0 ml-2 px-1"><i class="fas fa-times"></i></button>'
                    + '</div>';
            }).join('');
        }
        function removeFromSH(q, e) {
            e.stopPropagation();
            let users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            if (!users[currentUser]) return;
            users[currentUser].searchHistory = (users[currentUser].searchHistory || []).filter(s => s !== q);
            localStorage.setItem('tl_users', JSON.stringify(users));
            renderSearchHistoryDropdown(document.getElementById('searchInput').value);
        }
        function selectSearchHistory(q) {
            document.getElementById('searchInput').value = q;
            hideSearchHistory();
            handleSearch(q);
        }
        function showSearchHistory() {
            if (getSearchHistory().length === 0) return;
            renderSearchHistoryDropdown(document.getElementById('searchInput').value);
            document.getElementById('searchHistoryDropdown').classList.remove('hidden');
        }
        function hideSearchHistoryNow() {
            document.getElementById('searchHistoryDropdown').classList.add('hidden');
        }
        function hideSearchHistory() {
            setTimeout(function() {
                document.getElementById('searchHistoryDropdown').classList.add('hidden');
            }, 150);
        }
        function filterSearchHistory(val) {
            if (!val) { showSearchHistory(); return; }
            renderSearchHistoryDropdown(val);
            document.getElementById('searchHistoryDropdown').classList.remove('hidden');
        }

        // ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ
        function handleAuth() {
            const u = document.getElementById('authUser').value.trim();
            const p = document.getElementById('authPass').value.trim();
            if (!u || !p) return showToast("Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin", "error");

            let users = JSON.parse(localStorage.getItem('tl_users') || '{}');

            if (authMode === 'register') {
                if (users[u]) return showToast("T√™n n√†y ƒë√£ t·ªìn t·∫°i", "error");
                if (p.length < 4) return showToast("M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 4 k√Ω t·ª±", "error");
                users[u] = {
                    pass: p,
                    watchHistory: [],
                    personalKeys: [],
                    ytChannel: '',
                    avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(u)}&background=a855f7&color=fff`
                };
                localStorage.setItem('tl_users', JSON.stringify(users));
                showToast("ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ƒëƒÉng nh·∫≠p", "success");
                toggleAuthMode();
            } else {
                if (users[u] && users[u].pass === p) {
                    currentUser = u;
                    localStorage.setItem('tl_current', u);
                    initApp();
                    showToast(`Ch√†o m·ª´ng quay tr·ªü l·∫°i, ${u}! üëã`, "success");
                } else {
                    showToast("Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u", "error");
                }
            }
        }

        function initApp() {
            const users = JSON.parse(localStorage.getItem('tl_users') || '{}');
            const user = users[currentUser] || {};
            personalKeys = user.personalKeys || [];

            // Migrate old accounts that lack ytChannel field
            if (!user.ytChannel) { user.ytChannel = ''; users[currentUser] = user; localStorage.setItem('tl_users', JSON.stringify(users)); }

            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('userNameDisplay').innerText = currentUser;
            document.getElementById('userAvatarImg').src = user.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser)}&background=a855f7&color=fff`;

            // Show YT channel button if set
            const ytBtn = document.getElementById('ytChannelBtn');
            if (user.ytChannel) {
                ytBtn.classList.remove('hidden');
            } else {
                ytBtn.classList.add('hidden');
            }

            renderServerGrid();
            renderPersonalKeys();
            renderHistory();
            handleSearch('Minecraft Music');
        }

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('authTitle').innerHTML = authMode === 'login'
                ? 'Tube <span class="text-purple-500">Link</span>'
                : 'ƒêƒÉng <span class="text-purple-500">K√Ω</span>';
            document.getElementById('authToggle').innerText = authMode === 'login'
                ? 'Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay'
                : 'ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p';
        }

        function logout() {
            localStorage.removeItem('tl_current');
            location.reload();
        }

        function goHome() {
            document.getElementById('playerSection').classList.add('hidden');
            document.getElementById('mainIframe').src = '';
            handleSearch('Minecraft Music');
        }

        // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
        window.onload = () => {
            const saved = localStorage.getItem('tl_current');
            if (saved && JSON.parse(localStorage.getItem('tl_users') || '{}')[saved]) {
                currentUser = saved;
                initApp();
            }
        };
    </script>
</body>

</html>
